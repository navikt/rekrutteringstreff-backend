# Automatiske backend-tester

Dette dokumentet gir oversikt over teststatus og definerer oppgaver for manglende tester.

### ✅ Implementerte tester

| Område                                 | Testfil(er)                                                          | Dekning                                                                                                                                                                                                                  |
| -------------------------------------- | -------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Jobbsøker svar ja/nei**              | `JobbsøkerInnloggetBorgerTest.kt`                                    | ✅ `svar ja til invitasjon`, `svar nei til invitasjon`                                                                                                                                                                   |
| **Endre svar**                         | `JobbsøkerInnloggetBorgerTest.kt`                                    | ✅ `kan endre svar fra ja til nei`, `kan endre svar fra nei til ja`                                                                                                                                                      |
| **Avlysning med hendelser**            | `RekrutteringstreffTest.kt`                                          | ✅ `avlys oppretter hendelse for rekrutteringstreff og alle jobbsøkere med aktivt svar ja`                                                                                                                               |
| **Avlysning uten svar ja**             | `RekrutteringstreffTest.kt`                                          | ✅ `avlys oppretter kun rekrutteringstreff-hendelse når ingen jobbsøkere har aktivt svar ja`                                                                                                                             |
| **Fullføring**                         | `RekrutteringstreffTest.kt`                                          | ✅ `fullfor oppretter hendelse...` (flere varianter)                                                                                                                                                                     |
| **Endringsvarsel til inviterte**       | `RekrutteringstreffTest.kt`                                          | ✅ `registrer endring oppretter hendelser for publisert treff med inviterte jobbsøkere`                                                                                                                                  |
| **Endringsvarsel til svart ja**        | `RekrutteringstreffTest.kt`                                          | ✅ `registrer endring oppretter hendelser for publisert treff med jobbsøkere som har svart ja`                                                                                                                           |
| **Endringsvarsel IKKE til svart nei**  | `RekrutteringstreffTest.kt`                                          | ✅ `registrer endring varsler ikke jobbsøkere som har svart nei`                                                                                                                                                         |
| **Sletting av treff**                  | `RekrutteringstreffTest.kt`                                          | ✅ `slettRekrutteringstreffMedUpublisertedata`, `slett rekrutteringstreff feiler (409)...`                                                                                                                               |
| **Svar-service logikk**                | `JobbsøkerServiceTest.kt`                                            | ✅ `svarJaTilInvitasjon...`, `svarNeiTilInvitasjon...`, `finnJobbsøkereMedAktivtSvarJa...`                                                                                                                               |
| **Minside-varsel lytter**              | `MinsideVarselSvarLytterTest.kt`                                     | ✅ Omfattende                                                                                                                                                                                                            |
| **KI tekstvalidering**                 | `KiTekstvalideringTest.kt`                                           | ✅ Mange testcases                                                                                                                                                                                                       |
| **Persondata-filtrering**              | `PersondataFilterTest.kt`                                            | ✅ Dekket                                                                                                                                                                                                                |
| **Synlighet**                          | `SynlighetsKomponentTest.kt`, `SynlighetsLytterTest.kt` m.fl.        | ✅ Omfattende                                                                                                                                                                                                            |
| **Autorisasjon**                       | `*AutorisasjonsTest.kt` (flere filer)                                | ✅ Omfattende                                                                                                                                                                                                            |
| **Pilotkontor**                        | `PilotkontorTest.kt`                                                 | ✅ Dekket                                                                                                                                                                                                                |
| **Duplikat-håndtering**                | `EierRepositoryTest.kt`, `AktivitetskortTest.kt`                     | ✅ `leggTil legger ikke til duplikater`, duplikat-meldinger                                                                                                                                                              |
| **Dobbel invitasjon (race condition)** | `InvitasjonFeilhåndteringTest.kt`                                    | ✅ Idempotens implementert med radlås (SELECT FOR UPDATE)                                                                                                                                                                |
| **Svarfrist-validering**               | `JobbsøkerInnloggetBorgerTest.kt`                                    | ✅ `svar ja etter svarfrist avvises`, `svar nei etter svarfrist avvises`                                                                                                                                                 |
| **Ugyldig treff-ID**                   | `JobbsøkerInnloggetBorgerTest.kt`                                    | ✅ GET/POST til ukjent treff-ID gir feilkode                                                                                                                                                                             |
| **Dobbelt svar (idempotens)**          | `JobbsøkerInnloggetBorgerTest.kt`                                    | ✅ To svar-ja kall håndteres konsistent, samtidige kall                                                                                                                                                                  |
| **Veileder kan ikke invitere**         | `JobbsokerControllerAutorisasjonsTest.kt`                            | ✅ AT 5.1.8 - Jobbsøkerrettet får HTTP_FORBIDDEN på inviter-endepunkt                                                                                                                                                    |
| **Jobbsøker-synlighet per rolle**      | `JobbsokerControllerAutorisasjonsTest.kt`                            | ✅ AT 15.1.3, 15.2.3 - Kun eier/utvikler kan hente jobbsøkerliste                                                                                                                                                        |
| **Slett jobbsøker**                    | `JobbsokerControllerAutorisasjonsTest.kt`, `JobbsøkerServiceTest.kt` | ✅ AT 4.1.4 - markerSlettet med autorisasjon                                                                                                                                                                             |
| **Re-aktivering av slettet jobbsøker** | `JobbsøkerServiceTest.kt`                                            | ✅ AT 4.1.5 - Slettet jobbsøker kan legges til igjen                                                                                                                                                                     |
| **Avlysning: kun svart ja varsles**    | `RekrutteringstreffTest.kt`                                          | ✅ AT 8.1.4-8.1.7 - Kun SVART_JA får SVART_JA_TREFF_AVLYST hendelse                                                                                                                                                      |
| **Opprett treff validering**           | `RekrutteringstreffTest.kt`                                          | ✅ AT 1.1.3 - Ugyldig data/JSON gir 400 feilkode                                                                                                                                                                         |
| **Jobbsøker uten tilgang til treff**   | `JobbsøkerInnloggetBorgerTest.kt`                                    | ✅ AT 6.2.3 - Jobbsøker som ikke er lagt til får 404                                                                                                                                                                     |
| **Publiser treff**                     | `RekrutteringstreffTest.kt`                                          | ✅ AT 3.1.1 - Publisering endrer status fra UTKAST til PUBLISERT                                                                                                                                                         |
| **Tilstandsoverganger**                | `RekrutteringstreffTest.kt`                                          | ✅ `fullfor feiler når treffet ikke er passert i tid`, `fullfor feiler for AVLYST treff`, `avlys feiler for FULLFØRT treff`, `gjenapn feiler for UTKAST/PUBLISERT treff`, `publiser feiler for allerede PUBLISERT treff` |
| **Arbeidsgiver-validering**            | `ArbeidsgiverTest.kt`                                                | ✅ `ugyldig orgnummer gir 400`, `orgnummer med bokstaver gir 400`, `uten orgnummer/navn gir 400`, `tomt orgnummer gir 400`                                                                                               |
| **Jobbsøker API-idempotens**           | `JobbsøkerTest.kt`                                                   | ✅ AT 4.1.3 - `legg til samme jobbsøker to ganger gir idempotent respons`                                                                                                                                                |
| **Hendelseslogg-autorisasjon**         | `AutorisasjonsTest.kt`                                               | ✅ AT 14.1.8 - HentAlleHendelser med Arbeidsgiverrettet/erIkkeEier → HTTP_FORBIDDEN, Jobbsøkerrettet → HTTP_FORBIDDEN                                                                                                    |
| **Pilotkontor tilgangsstyring**        | `PilotkontorTest.kt`                                                 | ✅ AT 15.6.1-15.6.2 - `Person uten innlogget pilotkontor får ikke lov`, `Person med pilotkontor får lov`                                                                                                                 |

---

## ❌ Manglende tester – anbefalt å implementere

Følgende akseptansetester har backend-logikk som bør testes automatisk, men som ikke er dekket i dag:

### 1. KI bypass-sikkerhet (høy prioritet – ROS 27547)

| AT-ref | Beskrivelse                                                             | Anbefalt testfil         | Kompleksitet |
| ------ | ----------------------------------------------------------------------- | ------------------------ | ------------ |
| 11.8.2 | API-kall uten KI-validering avvises                                     | `KiAutorisasjonsTest.kt` | Middels      |
| 11.8.3 | Lagring med `flaggAdvarsel=true` uten `lagreLikevel` gir feil           | `KiAutorisasjonsTest.kt` | Middels      |
| 11.8.4 | Backend krever gyldig KI-valideringsresultat for å lagre tittel/innlegg | `KiAutorisasjonsTest.kt` | Høy          |

> ⚠️ **Merk:** Disse testene krever arkitekturendring. Per i dag er KI bypass-beskyttelse kun implementert i frontend. Backend har ingen `lagreLikevel`-parameter eller krav om gyldig KI-valideringsresultat. Se [ROS 27547](../ros-pilot.md) for detaljer.

---

## Anbefalte neste steg

1. **KI bypass-sikkerhet** – kritisk for ROS, men krever arkitekturendring først (backend har ingen `lagreLikevel`-parameter)
