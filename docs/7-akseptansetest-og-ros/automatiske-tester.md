# Automatiske backend-tester

Dette dokumentet gir oversikt over teststatus og definerer oppgaver for manglende tester.

### ✅ Implementerte tester

| Område                                 | Testfil(er)                                                                                 | Dekning                                                                                                                                                                                                                  |
| -------------------------------------- | ------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Jobbsøker svar ja/nei**              | `JobbsøkerInnloggetBorgerTest.kt`                                                           | ✅ `svar ja til invitasjon`, `svar nei til invitasjon`                                                                                                                                                                   |
| **Endre svar**                         | `JobbsøkerInnloggetBorgerTest.kt`                                                           | ✅ `kan endre svar fra ja til nei`, `kan endre svar fra nei til ja`                                                                                                                                                      |
| **Avlysning med hendelser**            | `RekrutteringstreffTest.kt`                                                                 | ✅ `avlys oppretter hendelse for rekrutteringstreff og alle jobbsøkere med aktivt svar ja`                                                                                                                               |
| **Avlysning uten svar ja**             | `RekrutteringstreffTest.kt`                                                                 | ✅ `avlys oppretter kun rekrutteringstreff-hendelse når ingen jobbsøkere har aktivt svar ja`                                                                                                                             |
| **Fullføring**                         | `RekrutteringstreffTest.kt`                                                                 | ✅ `fullfor oppretter hendelse...` (flere varianter)                                                                                                                                                                     |
| **Endringsvarsel til inviterte**       | `RekrutteringstreffTest.kt`                                                                 | ✅ `registrer endring oppretter hendelser for publisert treff med inviterte jobbsøkere`                                                                                                                                  |
| **Endringsvarsel til svart ja**        | `RekrutteringstreffTest.kt`                                                                 | ✅ `registrer endring oppretter hendelser for publisert treff med jobbsøkere som har svart ja`                                                                                                                           |
| **Endringsvarsel IKKE til svart nei**  | `RekrutteringstreffTest.kt`                                                                 | ✅ `registrer endring varsler ikke jobbsøkere som har svart nei`                                                                                                                                                         |
| **Sletting av treff**                  | `RekrutteringstreffTest.kt`                                                                 | ✅ `slettRekrutteringstreffMedUpublisertedata`, `slett rekrutteringstreff feiler (409)...`                                                                                                                               |
| **Svar-service logikk**                | `JobbsøkerServiceTest.kt`                                                                   | ✅ `svarJaTilInvitasjon...`, `svarNeiTilInvitasjon...`, `finnJobbsøkereMedAktivtSvarJa...`                                                                                                                               |
| **Minside-varsel lytter**              | `MinsideVarselSvarLytterTest.kt`                                                            | ✅ Omfattende                                                                                                                                                                                                            |
| **KI tekstvalidering**                 | `KiTekstvalideringTest.kt`                                                                  | ✅ Mange testcases                                                                                                                                                                                                       |
| **Persondata-filtrering**              | `PersondataFilterTest.kt`                                                                   | ✅ Dekket                                                                                                                                                                                                                |
| **Synlighet**                          | `SynlighetsKomponentTest.kt`, `SynlighetsLytterTest.kt` m.fl.                               | ✅ Omfattende                                                                                                                                                                                                            |
| **Autorisasjon**                       | `*AutorisasjonsTest.kt` (flere filer)                                                       | ✅ Omfattende                                                                                                                                                                                                            |
| **Pilotkontor**                        | `PilotkontorTest.kt`                                                                        | ✅ Dekket                                                                                                                                                                                                                |
| **Duplikat-håndtering**                | `EierRepositoryTest.kt`, `AktivitetskortTest.kt`                                            | ✅ `leggTil legger ikke til duplikater`, duplikat-meldinger                                                                                                                                                              |
| **Dobbel invitasjon (race condition)** | `InvitasjonFeilhåndteringTest.kt`                                                           | ✅ Idempotens implementert med radlås (SELECT FOR UPDATE)                                                                                                                                                                |
| **Invitasjon av usynlig jobbsøker**    | `InvitasjonFeilhåndteringTest.kt`                                                           | ✅ AT 5.4.2 - `invitasjon av ikke-synlig jobbsøker hoppes over mens synlige inviteres` - Usynlig hoppes over med warning-logg, synlige inviteres                                                                         |
| **Broadcast filtrerer usynlige**       | `AktivitetskortRepositoryTest.kt`                                                           | ✅ `hentUsendteHendelse skal filtrere ut hendelser for ikke-synlige jobbsøkere` - Kun synlige jobbsøkere får aktivitetskort/varsler                                                                                      |
| **Svarfrist-validering**               | `JobbsøkerInnloggetBorgerTest.kt`                                                           | ✅ `svar ja etter svarfrist avvises`, `svar nei etter svarfrist avvises`                                                                                                                                                 |
| **Ugyldig treff-ID**                   | `JobbsøkerInnloggetBorgerTest.kt`                                                           | ✅ GET/POST til ukjent treff-ID gir feilkode                                                                                                                                                                             |
| **Dobbelt svar (idempotens)**          | `JobbsøkerInnloggetBorgerTest.kt`                                                           | ✅ To svar-ja kall håndteres konsistent, samtidige kall                                                                                                                                                                  |
| **Veileder kan ikke invitere**         | `JobbsokerControllerAutorisasjonsTest.kt`                                                   | ✅ AT 5.1.8 - Jobbsøkerrettet får HTTP_FORBIDDEN på inviter-endepunkt                                                                                                                                                    |
| **Jobbsøker-synlighet per rolle**      | `JobbsokerControllerAutorisasjonsTest.kt`                                                   | ✅ AT 15.1.3, 15.2.3 - Kun eier/utvikler kan hente jobbsøkerliste                                                                                                                                                        |
| **Slett jobbsøker**                    | `JobbsokerControllerAutorisasjonsTest.kt`, `JobbsøkerServiceTest.kt`                        | ✅ AT 4.1.4 - markerSlettet med autorisasjon                                                                                                                                                                             |
| **Re-aktivering av slettet jobbsøker** | `JobbsøkerServiceTest.kt`                                                                   | ✅ AT 4.1.5 - Slettet jobbsøker kan legges til igjen                                                                                                                                                                     |
| **Avlysning: kun svart ja varsles**    | `RekrutteringstreffTest.kt`                                                                 | ✅ AT 8.1.4-8.1.7 - Kun SVART_JA får SVART_JA_TREFF_AVLYST hendelse                                                                                                                                                      |
| **Opprett treff validering**           | `RekrutteringstreffTest.kt`                                                                 | ✅ AT 1.1.3 - Ugyldig data/JSON gir 400 feilkode                                                                                                                                                                         |
| **Jobbsøker uten tilgang til treff**   | `JobbsøkerInnloggetBorgerTest.kt`                                                           | ✅ AT 6.2.3 - Jobbsøker som ikke er lagt til får 404                                                                                                                                                                     |
| **Publiser treff**                     | `RekrutteringstreffTest.kt`                                                                 | ✅ AT 3.1.1 - Publisering endrer status fra UTKAST til PUBLISERT                                                                                                                                                         |
| **Tilstandsoverganger**                | `RekrutteringstreffTest.kt`                                                                 | ✅ `fullfor feiler når treffet ikke er passert i tid`, `fullfor feiler for AVLYST treff`, `avlys feiler for FULLFØRT treff`, `gjenapn feiler for UTKAST/PUBLISERT treff`, `publiser feiler for allerede PUBLISERT treff` |
| **Arbeidsgiver-validering**            | `ArbeidsgiverTest.kt`                                                                       | ✅ `ugyldig orgnummer gir 400`, `orgnummer med bokstaver gir 400`, `uten orgnummer/navn gir 400`, `tomt orgnummer gir 400`                                                                                               |
| **Jobbsøker API-idempotens**           | `JobbsøkerTest.kt`                                                                          | ✅ AT 4.1.3 - `legg til samme jobbsøker to ganger gir idempotent respons`                                                                                                                                                |
| **Hendelseslogg-autorisasjon**         | `AutorisasjonsTest.kt`                                                                      | ✅ AT 14.1.8 - HentAlleHendelser med Arbeidsgiverrettet/erIkkeEier → HTTP_FORBIDDEN, Jobbsøkerrettet → HTTP_FORBIDDEN                                                                                                    |
| **Pilotkontor tilgangsstyring**        | `PilotkontorTest.kt`                                                                        | ✅ AT 15.6.1-15.6.2 - `Person uten innlogget pilotkontor får ikke lov`, `Person med pilotkontor får lov`                                                                                                                 |
| **Gjenåpning av treff**                | `RekrutteringstreffTest.kt`                                                                 | ✅ AT 8 - `gjenapn feiler for UTKAST treff`, `gjenapn feiler for PUBLISERT treff som ikke er avlyst`, `gjenapn fungerer for AVLYST treff`                                                                                |
| **Innlegg CRUD**                       | `InnleggTest.kt`, `InnleggRepositoryTest.kt`                                                | ✅ AT 10 - POST/PUT/GET/DELETE innlegg, oppdaterer innlegg, returnerer innlegg for treff                                                                                                                                 |
| **Innlegg-autorisasjon**               | `InnleggAutorisasjonsTest.kt`                                                               | ✅ Rolle- og eierskapsbasert tilgangsstyring for innlegg                                                                                                                                                                 |
| **Arbeidsgiver sletting**              | `ArbeidsgiverServiceTest.kt`                                                                | ✅ AT 2.1.3 - `slettArbeidsgiver skal legge til hendelse og endre status i samme transaksjon`, `slettArbeidsgiver returnerer false når arbeidsgiver ikke finnes`                                                         |
| **Aktivitetskort-synkronisering**      | `RekrutteringstreffOppdateringTest.kt`, `RekrutteringstreffSvarOgStatusLytterTest.kt`       | ✅ AT 7.3.2, 9.1.3-9.1.5 - Oppdatering av aktivitetskort ved endring, svar ja → gjennomføres, svar nei → avbrutt, fullført → fullført                                                                                    |
| **Aktivitetskort invitasjon**          | `RekrutteringstreffInvitasjonTest.kt`                                                       | ✅ AT 5.1.5 - Lesing av invitasjon oppretter aktivitetskort, returnerer aktivitetskort-UUID                                                                                                                              |
| **Synlighet ved endring**              | `SynlighetsKomponentTest.kt`                                                                | ✅ AT 4.2-4.8 - `jobbsøker som blir ikke-synlig forsvinner fra API`, `jobbsøker som blir synlig igjen dukker opp`, `synlighetsoppdatering påvirker alle treff`                                                           |
| **Synlighet-scheduler**                | `SynlighetsBehovSchedulerTest.kt`                                                           | ✅ Publiserer need for jobbsøkere uten evaluert synlighet                                                                                                                                                                |
| **Synlighet-lytter**                   | `SynlighetsBehovLytterTest.kt`, `SynlighetsLytterTest.kt`                                   | ✅ Oppdaterer synlighet fra event/need, håndterer ukjente personer                                                                                                                                                       |
| **Eier-håndtering**                    | `RekrutteringstreffEierTest.kt`, `EierRepositoryTest.kt`                                    | ✅ AT 15.3 - `Slett eier er lov hvis det er flere eiere`, `Slett eier hvis bare 1 eier gir bad request`, hent eiere for treff                                                                                            |
| **Eier-autorisasjon**                  | `RekrutteringstreffEierAutorisasjonsTest.kt`                                                | ✅ Rolle- og eierskapsbasert tilgangsstyring for eier-operasjoner                                                                                                                                                        |
| **Arbeidsgiver-autorisasjon**          | `ArbeidsgiverAutorisasjonsTest.kt`                                                          | ✅ AT 15.3.7 - Rolle- og eierskapsbasert tilgangsstyring for arbeidsgiver-operasjoner                                                                                                                                    |
| **Endring av fullførte treff**         | `RekrutteringstreffTest.kt`                                                                 | ✅ `registrer endring avvises for fullførte treff`                                                                                                                                                                       |
| **Aktivitetskort ved treff-endring**   | `AktivitetskortJobbsøkerSchedulerTest.kt`                                                   | ✅ AT 7.3.2-7.4.5 - Oppdatering av aktivitetskort og minside-varsel ved endring av relevante felt (tittel, tid, sted, svarfrist)                                                                                         |
| **Aktivitetskort feilhåndtering**      | `AktivitetskortFeilLytterTest.kt`                                                           | ✅ Lagrer feil-hendelse når aktivitetskort-opprettelse feiler                                                                                                                                                            |
| **Minside API (jobbsøkerflyt)**        | `MinsideTest.kt`                                                                            | ✅ AT 6 - `hent treff`, `hent arbeidsgivere for treff`, `hent svarstatus`, `avgi svarstatus`, token-validering                                                                                                           |
| **Kandidatnummer-oppslag**             | `jobbsøkerOutboundTest.kt`, `JobbsøkerOutboundControllerAutorisasjonsTest.kt`               | ✅ AT 13 - GET kandidatnummer returnerer forventet, autorisasjonstest                                                                                                                                                    |
| **Transaksjonsintegritet**             | `JobbsøkerServiceTest.kt`, `ArbeidsgiverServiceTest.kt`, `RekrutteringstreffServiceTest.kt` | ✅ Hendelser og statusendringer skjer atomisk i samme transaksjon, rollback ved feil                                                                                                                                     |
| **Sletting av treff med jobbsøkere**   | `RekrutteringstreffServiceTest.kt`, `RekrutteringstreffTest.kt`                             | ✅ AT 1.3 - `skal ikke kunne slette treff som har jobbsøkere`, `slett feiler etter publisering`                                                                                                                          |
| **Feilhåndtering JSON-parsing**        | `AppExceptionHandlingTest.kt`                                                               | ✅ AT 1.1.3, 2.4.1 - `ugyldig JSON gir 400`, `gyldig JSON men feil mapping gir 400`                                                                                                                                      |
| **Audit-logging (CEF-format)**         | `AuditLogTest.kt`                                                                           | ✅ Korrekt CEF-struktur for sporingslogg, med og uten fødselsnummer                                                                                                                                                      |
| **Kubernetes health-sjekker**          | `KubernetesHealthTest.kt`                                                                   | ✅ `/isalive` og `/isready` endepunkter fungerer                                                                                                                                                                         |
| **Swagger/API-dokumentasjon**          | `SwaggerEndpointsTest.kt`                                                                   | ✅ Swagger-endepunkter responderer OK                                                                                                                                                                                    |
| **Hendelseslogg-repository**           | `RekrutteringstreffRepositoryTest.kt`                                                       | ✅ AT 14 - `hentAlleHendelser inkluderer rekrutteringstreff- og arbeidsgiver-hendelser`                                                                                                                                  |
| **Hent rekrutteringstreff**            | `RekrutteringstreffServiceTest.kt`                                                          | ✅ AT 12 - Hent alle treff, hent for kontor, hent enkelt treff med hendelser                                                                                                                                             |
| **Aktivitetskort-transaksjon**         | `AktivitetskortTransaksjonTest.kt`                                                          | ✅ Aktivitetskort og hendelser håndteres atomisk                                                                                                                                                                         |
| **Aktivitetskort svart-ja-scheduler**  | `AktivitetskortSvartJaTreffstatusSchedulerTest.kt`                                          | ✅ AT 9 - Oppdaterer aktivitetskort-status basert på treffstatus                                                                                                                                                         |
| **Jobbsøker-repository**               | `JobbsøkerRepositoryTest.kt`                                                                | ✅ CRUD-operasjoner og statusoppdateringer for jobbsøkere                                                                                                                                                                |
| **Arbeidsgiver-repository**            | `ArbeidsgiverRepositoryTest.kt`                                                             | ✅ AT 2 - CRUD-operasjoner for arbeidsgivere                                                                                                                                                                             |
| **KI-logg repository**                 | `KiLoggRepositoryTest.kt`                                                                   | ✅ AT 11.4 - Lagring og henting av KI-valideringslogg                                                                                                                                                                    |
| **KI-autorisasjon**                    | `KiAutorisasjonsTest.kt`                                                                    | ✅ AT 15.4.1 - Kun utviklere kan se KI-logg                                                                                                                                                                              |
| **KI-integrasjon**                     | `KiTest.kt`                                                                                 | ✅ AT 11 - KI-validering av tekst                                                                                                                                                                                        |

---

## ❌ Manglende tester – anbefalt å implementere

Følgende akseptansetester har backend-logikk som bør testes automatisk, men som ikke er dekket i dag:

### 1. KI bypass-sikkerhet (høy prioritet – ROS 27547)

| AT-ref | Beskrivelse                                                             | Anbefalt testfil         | Kompleksitet |
| ------ | ----------------------------------------------------------------------- | ------------------------ | ------------ |
| 11.8.2 | API-kall uten KI-validering avvises                                     | `KiAutorisasjonsTest.kt` | Middels      |
| 11.8.3 | Lagring med `flaggAdvarsel=true` uten `lagreLikevel` gir feil           | `KiAutorisasjonsTest.kt` | Middels      |
| 11.8.4 | Backend krever gyldig KI-valideringsresultat for å lagre tittel/innlegg | `KiAutorisasjonsTest.kt` | Høy          |

> ⚠️ **Merk:** Disse testene krever arkitekturendring. Per i dag er KI bypass-beskyttelse kun implementert i frontend. Backend har ingen `lagreLikevel`-parameter eller krav om gyldig KI-valideringsresultat. Se [ROS 27547](../ros-pilot.md) for detaljer.

---

## Anbefalte neste steg

1. **KI bypass-sikkerhet** – kritisk for ROS, men krever arkitekturendring først (backend har ingen `lagreLikevel`-parameter)
